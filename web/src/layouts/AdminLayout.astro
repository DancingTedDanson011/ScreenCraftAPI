---
import Layout from './Layout.astro';

interface Props {
  title: string;
  activeTab?: string;
}

const { title, activeTab } = Astro.props;

const navItems = [
  { name: 'Dashboard', href: '/admin', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', key: 'd' },
  { name: 'Users', href: '/admin/users', icon: 'M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z', key: 'u' },
  { name: 'API Keys', href: '/admin/api-keys', icon: 'M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z', key: 'k' },
  { name: 'Jobs', href: '/admin/jobs', icon: 'M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z', key: 'j' },
  { name: 'Messages', href: '/admin/messages', icon: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z', key: 'm' },
  { name: 'Logs', href: '/admin/logs', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z', key: 'l' },
];
---

<Layout title={`Admin: ${title} | ScreenCraft`}>
  <div class="min-h-screen bg-[#0D1117] flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#161B22] border-r border-[#30363D] flex flex-col">
      <!-- Logo -->
      <div class="p-4 border-b border-[#30363D]">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-bold text-[#F0F6FC]">OVERWATCH</h1>
            <p class="text-xs text-[#8B949E]">Admin Terminal</p>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-3 space-y-1">
        {navItems.map(item => (
          <a
            href={item.href}
            class:list={[
              'flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group',
              activeTab === item.name.toLowerCase()
                ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30'
                : 'text-[#8B949E] hover:bg-[#21262D] hover:text-[#F0F6FC]'
            ]}
            data-key={item.key}
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={item.icon} />
            </svg>
            <span class="font-medium">{item.name}</span>
            <kbd class="ml-auto text-xs px-1.5 py-0.5 rounded bg-[#21262D] text-[#8B949E] opacity-0 group-hover:opacity-100 transition-opacity">
              {item.key}
            </kbd>
          </a>
        ))}
      </nav>

      <!-- Footer -->
      <div class="p-4 border-t border-[#30363D]">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-8 h-8 bg-[#21262D] rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 text-[#8B949E]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <p id="admin-name" class="text-sm font-medium text-[#F0F6FC] truncate">Admin</p>
            <p id="admin-role" class="text-xs text-[#8B949E]">Loading...</p>
          </div>
        </div>
        <button
          id="logout-btn"
          class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-[#21262D] text-[#F85149] hover:bg-[#F85149]/10 transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="bg-[#161B22] border-b border-[#30363D] px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-xl font-semibold text-[#F0F6FC]">{title}</h2>
            <p class="text-sm text-[#8B949E]" id="current-time"></p>
          </div>
          <div class="flex items-center gap-4">
            <!-- Connection Status -->
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#21262D]">
              <div id="ws-status" class="w-2 h-2 rounded-full bg-[#8B949E] animate-pulse"></div>
              <span id="ws-status-text" class="text-xs text-[#8B949E]">Connecting...</span>
            </div>
            <!-- Refresh Button -->
            <button
              id="refresh-btn"
              class="p-2 rounded-lg bg-[#21262D] text-[#8B949E] hover:text-[#F0F6FC] hover:bg-[#30363D] transition-colors"
              title="Refresh (r)"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
            </button>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="flex-1 overflow-auto p-6">
        <slot />
      </div>
    </main>
  </div>

  <!-- Keyboard shortcuts toast -->
  <div id="keyboard-toast" class="fixed bottom-4 right-4 bg-[#21262D] border border-[#30363D] rounded-lg p-4 opacity-0 pointer-events-none transition-opacity duration-300">
    <p class="text-sm text-[#F0F6FC] font-medium mb-2">Keyboard Shortcuts</p>
    <div class="grid grid-cols-2 gap-2 text-xs text-[#8B949E]">
      <span><kbd class="px-1 bg-[#30363D] rounded">d</kbd> Dashboard</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">u</kbd> Users</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">k</kbd> API Keys</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">j</kbd> Jobs</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">m</kbd> Messages</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">l</kbd> Logs</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">r</kbd> Refresh</span>
      <span><kbd class="px-1 bg-[#30363D] rounded">?</kbd> Help</span>
    </div>
  </div>
</Layout>

<script>
  // Dynamic API URL
  const API_URL = window.location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : `${window.location.protocol}//${window.location.hostname}`;

  // Check authentication
  const token = localStorage.getItem('adminToken');
  if (!token) {
    window.location.href = '/admin/login';
  }

  // Load admin info
  async function loadAdminInfo() {
    try {
      const response = await fetch(`${API_URL}/admin/api/auth/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error('Not authenticated');
      }

      const data = await response.json();
      const nameEl = document.getElementById('admin-name');
      const roleEl = document.getElementById('admin-role');
      if (nameEl) nameEl.textContent = data.admin.name;
      if (roleEl) roleEl.textContent = data.admin.role;
    } catch (error) {
      localStorage.removeItem('adminToken');
      window.location.href = '/admin/login';
    }
  }

  loadAdminInfo();

  // Update time
  function updateTime() {
    const timeEl = document.getElementById('current-time');
    if (timeEl) {
      timeEl.textContent = new Date().toLocaleString('de-DE', {
        weekday: 'short',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
  }
  updateTime();
  setInterval(updateTime, 1000);

  // Logout handler
  document.getElementById('logout-btn')?.addEventListener('click', async () => {
    try {
      await fetch(`${API_URL}/admin/api/auth/logout`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
    } catch (e) {
      // Ignore errors
    }
    localStorage.removeItem('adminToken');
    window.location.href = '/admin/login';
  });

  // Keyboard shortcuts
  const shortcuts: Record<string, string> = {
    'd': '/admin',
    'u': '/admin/users',
    'k': '/admin/api-keys',
    'j': '/admin/jobs',
    'm': '/admin/messages',
    'l': '/admin/logs',
  };

  let showingHelp = false;

  document.addEventListener('keydown', (e) => {
    // Don't trigger if typing in an input
    if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) {
      return;
    }

    const key = e.key.toLowerCase();

    if (key === '?') {
      const toast = document.getElementById('keyboard-toast');
      if (toast) {
        showingHelp = !showingHelp;
        toast.classList.toggle('opacity-0', !showingHelp);
        toast.classList.toggle('pointer-events-none', !showingHelp);
      }
      return;
    }

    if (key === 'r') {
      // Dispatch custom refresh event
      window.dispatchEvent(new CustomEvent('admin-refresh'));
      return;
    }

    if (shortcuts[key]) {
      window.location.href = shortcuts[key];
    }
  });

  // Refresh button
  document.getElementById('refresh-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('admin-refresh'));
  });
</script>

<style>
  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #161B22;
  }

  ::-webkit-scrollbar-thumb {
    background: #30363D;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #484F58;
  }

  /* Animation for status indicator */
  @keyframes pulse-green {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  .ws-connected {
    background-color: #238636 !important;
    animation: pulse-green 2s infinite;
  }

  .ws-disconnected {
    background-color: #F85149 !important;
  }
</style>
